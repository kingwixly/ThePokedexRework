<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Pokedex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Georgia&family=Courier+New&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Custom Properties for Theming & Fonts --- */
        :root {
            --font-family: 'Inter', sans-serif;
            --font-weight-normal: 400;
            --font-weight-bold: 700;
            --current-font-weight: var(--font-weight-normal);

            /* Light Mode (Default) */
            --bg-page: #f3f4f6; /* gray-100 */
            --text-default: #1f2937; /* gray-800 */
            --text-muted: #6b7280; /* gray-500 */
            --text-panel-default: var(--text-default);
            --panel-bg: #ffffff;
            --panel-bg-image: none;
            --panel-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-color: #d1d5db; /* gray-300 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
            --accent-focus-ring: rgba(59, 130, 246, 0.2);
            --list-item-hover-bg: #f0f9ff; /* blue-50 */
            --list-item-hover-border: #dbeafe; /* blue-100 */
            --list-item-selected-bg: #dbeafe; /* blue-100 */
            --list-item-selected-border: var(--accent-color);
            --list-item-selected-text: #1e3a8a; /* blue-800 */
            --button-secondary-bg: #e5e7eb; /* gray-200 */
            --button-secondary-text: #4b5563; /* gray-600 */
            --modal-bg: #ffffff;
        }

        body.dark-mode {
            --bg-page: #111827;
            --text-default: #f3f4f6;
            --text-muted: #9ca3af;
            --text-panel-default: var(--text-default);
            --panel-bg: #1f2937;
            --panel-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --border-color: #4b5563;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
            --accent-focus-ring: rgba(96, 165, 250, 0.3);
            --list-item-hover-bg: #374151;
            --list-item-hover-border: #4b5563;
            --list-item-selected-bg: #4b5563;
            --list-item-selected-border: var(--accent-color);
            --list-item-selected-text: #dbeafe;
            --button-secondary-bg: #374151;
            --button-secondary-text: #d1d5db;
            --modal-bg: #1f2937;
        }

        body.legacy-mode {
            --bg-page: #f3f4f6;
            --text-default: #1f2937;
            --text-muted: #4b5563;
            --text-panel-default: #1f2937;
            /* Pokedex Body (Red Shell) */
            --pokedex-body-bg-start: #dc2626;
            --pokedex-body-bg-end: #b91c1c;
            --pokedex-body-border: #991b1b;
            --pokedex-body-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1), inset 0 0 15px rgba(0,0,0,0.4);
            /* Screens */
            --panel-bg: #D1D5DB;
            --panel-bg-image: linear-gradient(to bottom, #e5e7eb, #d1d5db);
            --panel-border: #4B5563;
            --panel-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
            /* Accent for legacy */
            --accent-color: #ef4444;
            --accent-hover: #dc2626;
            --accent-focus-ring: rgba(239, 68, 68, 0.3);
            --modal-bg: #D1D5DB;
            --list-item-selected-bg: #9ca3af;
            --list-item-selected-border: var(--accent-color);
            --list-item-selected-text: #ffffff;
        }


        /* --- Base Styles using CSS Variables --- */
        body {
            font-family: var(--font-family);
            font-weight: var(--current-font-weight);
            background-color: var(--bg-page);
            color: var(--text-default);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .pokedex-container-wrapper {
            flex-grow: 1;
            padding: 1rem;
            position: relative; /* For legacy deco positioning */
        }
        body.legacy-mode .pokedex-container-wrapper {
            background-image: linear-gradient(to bottom, var(--pokedex-body-bg-start), var(--pokedex-body-bg-end));
            border: 10px solid var(--pokedex-body-border);
            box-shadow: var(--pokedex-body-shadow);
            border-radius: 1.5rem; /* Slightly larger than panels */
            padding: 1.5rem; /* Padding for the shell itself */
            margin: 1rem auto; /* Center shell */
            max-width: calc(64rem + 3rem); /* max-w-6xl + shell padding */
        }
        .pokedex-container { /* This is the grid container */ }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--button-secondary-bg); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-default); }

        /* --- Layout & Panel Styling --- */
        .panel {
            background-color: var(--panel-bg);
            background-image: var(--panel-bg-image);
            border-radius: 0.75rem;
            box-shadow: var(--panel-shadow);
            border: 5px solid transparent;
            border-color: var(--panel-border, transparent);
            padding: 1.5rem; display: flex; flex-direction: column;
            overflow-y: auto; height: 80vh; max-height: 700px; min-height: 550px; position: relative;
            transition: background-color 0.3s ease, background-image 0.3s ease, border-color 0.3s ease;
            color: var(--text-panel-default);
        }
        body.legacy-mode .panel { border-color: var(--panel-border); }

        /* --- Header for Icons --- */
        #app-header { display: flex; justify-content: flex-end; align-items: center; padding: 0.5rem 1rem; margin-bottom: 0.5rem; position: sticky; top: 0; background-color: var(--bg-page); z-index: 40; }
        .header-icon-button { background: none; border: none; padding: 0.5rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s ease; }
        .header-icon-button:hover { color: var(--accent-color); }
        .header-icon-button svg { width: 1.5rem; height: 1.5rem; }

        /* --- Legacy Decorative Elements --- */
        .legacy-deco { display: none; }
        body.legacy-mode .legacy-deco { display: block; position: absolute; }
        .legacy-deco-light { width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.5); box-shadow: inset 0 0 5px rgba(0,0,0,0.3); }
        /* Positioning relative to pokedex-container-wrapper (the red shell) */
        .legacy-deco-light.blue { background-color: #3b82f6; top: 0.75rem; left: 1.25rem; width: 30px; height: 30px;}
        .legacy-deco-light.red { background-color: #f87171; top: calc(0.75rem + 7px); left: calc(1.25rem + 40px);} /* Adjusted left */
        .legacy-deco-light.yellow { background-color: #facc15; top: calc(0.75rem + 7px); left: calc(1.25rem + 70px);} /* Adjusted left */
        .legacy-deco-light.green { background-color: #4ade80; top: calc(0.75rem + 7px); left: calc(1.25rem + 100px);} /* Adjusted left */
        .legacy-deco-button { border-radius: 0.375rem; background-color: #4b5563; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .legacy-deco-button.rect { bottom: 0.75rem; left: 1.5rem; width: 50px; height: 15px; }
        .legacy-deco-button.circle { bottom: 0.6rem; left: 5.5rem; width: 30px; height: 30px; border-radius: 50%; background-color: #374151; }

        /* Panel Titles (h2, section-title) */
        .panel h2, .panel .section-title, #pokemon-name, #pokemon-id {
            color: var(--text-panel-default);
        }
        body.dark-mode .panel h2, body.dark-mode .panel .section-title,
        body.dark-mode #pokemon-name, body.dark-mode #pokemon-id {
            color: var(--text-default); /* Light text on dark panels */
        }
        body.legacy-mode .panel h2, body.legacy-mode .panel .section-title,
        body.legacy-mode #pokemon-name, body.legacy-mode #pokemon-id {
            color: #1f2937; /* Dark text on light gray legacy screens */
        }


        .loader { border: 4px solid var(--button-secondary-bg); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        .small-loader { border: 3px solid var(--button-secondary-bg); border-top: 3px solid var(--accent-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #image-container { margin-bottom: 0.5rem; }
        #pokemon-image { transition: opacity 0.4s ease-in-out; display: block; margin: auto; image-rendering: pixelated; }
        #gender-buttons { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem; min-height: 36px; }
        .gender-button { font-size: 1.25rem; line-height: 1; padding: 0.3rem 0.6rem; border: 2px solid transparent; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; background-color: var(--button-secondary-bg); color: var(--text-muted); }
        .gender-button:disabled { cursor: not-allowed; opacity: 0.5; }
        .gender-button.active-male { background-color: #dbeafe; border-color: #3b82f6; color: #1e3a8a; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .gender-button.active-female { background-color: #fce7f3; border-color: #ec4899; color: #831843; box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.3); }
        #gender-buttons.hidden { display: none; }
        .stat-bar-bg { background-color: var(--button-secondary-bg); border-radius: 0.5rem; overflow: hidden; height: 0.75rem; width: 100%; position: relative; }
        .stat-bar { height: 100%; border-radius: 0.5rem; transition: width 0.5s ease-in-out; background-color: var(--accent-color); }
        #pokemon-stats .text-xs { font-size: 0.75rem; color: var(--text-panel-default); }
        #pokemon-stats .font-semibold { color: var(--text-muted); }
        .type-badge { padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); text-transform: capitalize; }
        .type-normal { background-color: #A8A77A; color: white; } .type-fire { background-color: #EE8130; color: white; } .type-water { background-color: #6390F0; color: white; } .type-electric { background-color: #F7D02C; color: #212121; } .type-grass { background-color: #7AC74C; color: white; } .type-ice { background-color: #96D9D6; color: #212121; } .type-fighting { background-color: #C22E28; color: white; } .type-poison { background-color: #A33EA1; color: white; } .type-ground { background-color: #E2BF65; color: #212121; } .type-flying { background-color: #A98FF3; color: white; } .type-psychic { background-color: #F95587; color: white; } .type-bug { background-color: #A6B91A; color: white; } .type-rock { background-color: #B6A136; color: white; } .type-ghost { background-color: #735797; color: white; } .type-dragon { background-color: #6F35FC; color: white; } .type-dark { background-color: #705746; color: white; } .type-steel { background-color: #B7B7CE; color: #212121; } .type-fairy { background-color: #D685AD; color: white; }
        #pokemon-forms { min-height: 24px; }
        .form-link { display: inline-block; cursor: pointer; background-color: #e0f2fe; color: #0369a1; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin: 0.25rem; transition: background-color 0.2s ease, color 0.2s ease; text-transform: capitalize; }
        .form-link:hover { background-color: #bae6fd; color: #0284c7; }
        #pokemon-list { flex-grow: 1; }
        .pokemon-list-item { cursor: pointer; transition: background-color 0.2s ease, border-left-width 0.2s ease; display: flex; align-items: center; padding: 0.5rem; border-left: 4px solid transparent; border-radius: 0.375rem; position: relative; }
        .pokemon-list-item img { width: 32px; height: 32px; margin-right: 10px; image-rendering: pixelated; vertical-align: middle; }
        .pokemon-list-item img.error { display: none; }
        .pokemon-list-item span { flex-grow: 1; color: var(--text-panel-default); font-size: 0.875rem; }
        .pokemon-list-item:hover { background-color: var(--list-item-hover-bg); border-left-color: var(--list-item-hover-border); }
        .pokemon-list-item.selected { background-color: var(--list-item-selected-bg); border-left-color: var(--list-item-selected-border); font-weight: 600; }
        .pokemon-list-item.selected span { color: var(--list-item-selected-text); }
        #pokemon-evolution { border-top: 1px solid var(--border-color); color: var(--text-muted); }
        #pokemon-evolution .font-medium { color: var(--text-panel-default); } /* Ensure evolution labels use panel text color */
        .evolution-link { cursor: pointer; color: var(--accent-color); text-decoration: none; font-weight: 500; }
        .evolution-link:hover { color: var(--accent-hover); text-decoration: underline; }
        #search-container { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        #search-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; background-color: var(--panel-bg); color: var(--text-panel-default); }
        #search-input::placeholder { color: var(--text-muted); }
        #search-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-focus-ring); }
        #search-info-button { flex-shrink: 0; padding: 0.5rem; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 0.375rem; transition: color 0.2s ease, background-color 0.2s ease; }
        #search-info-button:hover { color: var(--text-default); background-color: var(--button-secondary-bg); }
        #search-info-button svg { width: 1.25rem; height: 1.25rem; }
        footer { color: var(--text-muted); }
        footer a, footer button { color: var(--accent-color); display: inline-flex; align-items: center; background: none; border: none; padding: 0; cursor: pointer; }
        footer a:hover, footer button:hover { color: var(--accent-hover); text-decoration: underline; }
        footer svg { width: 1em; height: 1em; margin-right: 0.25em; vertical-align: text-bottom; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; transition: opacity 0.3s ease; }
        .modal-box { background-color: var(--modal-bg); color: var(--text-default); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-width: 90%; width: 450px; position: relative; }
        .modal-close-button { position: absolute; top: 0.5rem; right: 0.5rem; color: var(--text-muted); font-size: 1.5rem; line-height: 1; border: none; background: none; cursor: pointer; padding: 0.25rem; }
        .modal-close-button:hover { color: var(--text-default); }
        .hidden { display: none !important; }
        .modal-box code { background-color: var(--button-secondary-bg); padding: 0.1em 0.4em; border-radius: 0.25rem; font-size: 0.9em; }
        .modal-box label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted); }
        .modal-box select, .modal-box input[type="color"], .modal-box input[type="text"] { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color); background-color: var(--bg-page); color: var(--text-default); margin-bottom: 1rem; }
        .modal-box input[type="color"] { height: 2.5rem; padding: 0.25rem; }
        .modal-box .theme-option-button { padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid var(--border-color); background-color: var(--button-secondary-bg); color: var(--text-default); cursor: pointer; transition: background-color 0.2s ease; }
        .modal-box .theme-option-button:hover { background-color: var(--border-color); }
        .modal-box .theme-option-button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

    </style>
</head>
<body class="p-4 md:p-8">

    <header id="app-header" class="max-w-6xl mx-auto w-full">
        <button id="theme-button" class="header-icon-button" aria-label="Customize Theme">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M10 3.5A1.5 1.5 0 0111.5 2h.097A1.5 1.5 0 0113.097 3.5H13.5A1.5 1.5 0 0115 5v.097A1.5 1.5 0 0116.5 6.597V7A1.5 1.5 0 0118 8.5v.097A1.5 1.5 0 0119.5 10.097V10.5A1.5 1.5 0 0118 12v.097A1.5 1.5 0 0116.5 13.597V14A1.5 1.5 0 0115 15.5v.097A1.5 1.5 0 0113.5 17.097V17.5A1.5 1.5 0 0112 19h-.097A1.5 1.5 0 0110.403 17.5H10A1.5 1.5 0 018.5 16V6.5A1.5 1.5 0 017 5V3.5A1.5 1.5 0 018.5 2h.097A1.5 1.5 0 0110.097 3.5H10zM8.5 7H10v3H8.5V7zm2 7V7h1.5v10H12v-1.5a1.5 1.5 0 00-1.5-1.5h0zM5 3.5A1.5 1.5 0 016.5 2h.097A1.5 1.5 0 018.097 3.5H8.5A1.5 1.5 0 0110 5v7A1.5 1.5 0 018.5 13.5h-.097A1.5 1.5 0 016.903 12H6.5A1.5 1.5 0 015 10.5V3.5z" /> <path d="M2 5.5A1.5 1.5 0 013.5 4h.097A1.5 1.5 0 015.097 5.5H5.5A1.5 1.5 0 017 7v7A1.5 1.5 0 015.5 15.5h-.097A1.5 1.5 0 013.903 14H3.5A1.5 1.5 0 012 12.5v-7z" /> </svg>
        </button>
        <button id="settings-button" class="header-icon-button" aria-label="Open Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.566.379-1.566 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.54.886.061 2.042.947 2.287 1.566.379 1.566 2.6 0 2.978a1.532 1.532 0 01-.947 2.287c.54.886-.061 2.042-.947 2.287-1.566.379-1.566 2.6 0 2.978.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.566-.379 1.566-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.54-.886-.061-2.042-.947-2.287-1.566-.379-1.566-2.6 0-2.978a1.532 1.532 0 01.947-2.287c-.54-.886.061-2.042.947-2.287 1.566.379 1.566 2.6 0 2.978zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /> </svg>
        </button>
    </header>

    <div class="pokedex-container-wrapper max-w-6xl mx-auto">
        <div class="legacy-deco legacy-deco-light blue"></div>
        <div class="legacy-deco legacy-deco-light red"></div>
        <div class="legacy-deco legacy-deco-light yellow"></div>
        <div class="legacy-deco legacy-deco-light green"></div>
        <div class="legacy-deco legacy-deco-button rect"></div>
        <div class="legacy-deco legacy-deco-button circle"></div>

        <div class="pokedex-container grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="panel details-panel">
                <div class="text-center mb-4"> <h2 id="pokemon-name" class="text-3xl md:text-4xl font-bold capitalize mb-1">Welcome!</h2> <p id="pokemon-id" class="text-lg font-medium">Select a Pokémon</p> </div>
                <div id="image-container" class="w-48 h-48 md:w-56 md:h-56 flex items-center justify-center mx-auto"> <div id="detail-loader" class="loader" style="display: none;"></div> <img id="pokemon-image" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/54.png" alt="Confused Psyduck waiting for selection" class="max-w-full max-h-full object-contain" onerror="this.onerror=null; this.src='https://placehold.co/150x150/e0e0e0/a0a0a0?text=Error'; this.alt='Error loading image'"> </div>
                <div id="gender-buttons" class="hidden"> <button id="btn-male" class="gender-button" data-gender="male" title="Male">♂</button> <button id="btn-female" class="gender-button" data-gender="female" title="Female">♀</button> </div>
                <div id="pokemon-types" class="flex justify-center flex-wrap gap-2 mb-6 min-h-[30px]"> <span class="text-gray-500 italic text-sm">Types will appear here</span> </div>
                <div id="pokemon-forms-container" class="w-full max-w-md mx-auto mb-6 hidden"> <p class="section-title text-sm">Other Forms</p> <div id="pokemon-forms" class="text-center"> </div> </div>
                <div id="pokemon-stats" class="w-full max-w-md text-sm mx-auto mb-6"> <div class="text-center text-gray-500 italic">Stats will appear here</div> </div>
                <div id="pokemon-evolution" class="w-full max-w-md text-sm mx-auto mt-auto pt-4"> <p class="section-title text-sm">Evolution Chain</p> <div id="evolution-content" class="text-center text-gray-500 italic">Evolution details will appear here</div> <div id="evolution-loader" class="text-center" style="display: none;">Loading evolution... <div class="small-loader"></div></div> </div>
            </div>

            <div class="panel list-panel">
                <h2 class="text-xl font-bold mb-4 text-center">Pokémon List</h2>
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Search by name or #ID...">
                    <button id="search-info-button" aria-label="Search Help">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /> </svg>
                    </button>
                </div>
                <div id="list-loader" class="loader"></div>
                <p id="list-loading-message" class="text-center text-gray-600 mb-2" style="display: none;">Loading full Pokémon list...</p>
                <ul id="pokemon-list" class="overflow-y-auto space-y-1 pr-2 -mr-2"> </ul>
            </div>
        </div>
    </div>

    <footer class="text-center text-xs mt-8 pb-4 flex justify-center items-center space-x-4">
         <button id="credits-button" class="hover:underline">Credits</button>
         <span class="text-gray-400">|</span>
         <a href="https://discord.gg/xZ4F6chRCv" target="_blank" rel="noopener noreferrer" class="hover:underline">
            <svg fill="currentColor" viewBox="0 0 127.14 96.36" xmlns="http://www.w3.org/2000/svg"><path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,22.61-.21,42.76.07,63.91c2.71,3.86,6.65,7.13,11.29,9.59a84.54,84.54,0,0,0,6.58-5.32c-.42-.31-.83-.64-1.21-1a72.29,72.29,0,0,1-7.44-6.6c.23-.14.44-.28.66-.43A87.54,87.54,0,0,0,63.57,85.78a87.73,87.73,0,0,0,43.38-14.29c.22.15.43.29.66.43a72.17,72.17,0,0,1-7.44,6.6c-.38.34-.79.67-1.21,1a84.39,84.39,0,0,0,6.58,5.32c4.64-2.45,8.58-5.73,11.29-9.59C127.74,44.44,124.91,24.79,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.41-12.74S53.86,46,53.86,53,48.72,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.12,46,96.12,53,91,65.69,84.69,65.69Z"></path></svg>
            <span>Help / Join Discord</span>
        </a>
    </footer>

    <div id="credits-modal" class="modal-overlay hidden"> <div id="modal-box-credits" class="modal-box"> <button id="modal-close-button-credits" class="modal-close-button" aria-label="Close modal">&times;</button> <h3 class="text-lg font-semibold mb-4 text-center">Credits</h3> <div class="text-sm space-y-2"> <p>Data provided by <a href="https://pokeapi.co/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">PokéAPI (V2)</a>.</p> <p>Project Repository: <a href="https://github.com/kingwixly/ThePokedex" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">ThePokedex on GitHub</a>.</p> <p>Built with HTML, Tailwind CSS, and JavaScript.</p> <p class="text-xs text-gray-500 mt-4">Pokémon and Pokémon character names are trademarks of Nintendo.</p> </div> </div> </div>
    <div id="search-help-modal" class="modal-overlay hidden"> <div id="modal-box-search-help" class="modal-box"> <button id="search-help-modal-close-button" class="modal-close-button" aria-label="Close modal">&times;</button> <h3 class="text-lg font-semibold mb-4 text-center">Search Help</h3> <div class="text-sm space-y-3"> <p>You can search the list in the following ways:</p> <ul class="list-disc list-inside space-y-1"> <li> <strong>By Name:</strong> Type part of a Pokémon's name (e.g., <code>pika</code>, <code>char</code>). </li> <li> <strong>By Exact ID:</strong> Type <code>#</code> followed by the Pokédex number (e.g., <code>#25</code>, <code>#151</code>). This shows only the Pokémon with that exact ID. </li> <li> <strong>By Number (ID Starts With or Name):</strong> Type just the number (e.g., <code>1</code>, <code>18</code>). This shows Pokémon whose ID *starts with* that number, as well as any Pokémon whose name contains that number. </li> </ul> </div> </div> </div>

    <div id="theme-settings-modal" class="modal-overlay hidden">
        <div id="modal-box-theme" class="modal-box">
            <button id="theme-modal-close-button" class="modal-close-button" aria-label="Close modal">&times;</button>
            <h3 class="text-lg font-semibold mb-6 text-center">Theme Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Mode:</label>
                    <div class="flex space-x-2">
                        <button class="theme-option-button flex-1" data-theme-mode="light">Light</button>
                        <button class="theme-option-button flex-1" data-theme-mode="dark">Dark</button>
                        <button class="theme-option-button flex-1" data-theme-mode="legacy">Legacy</button>
                    </div>
                </div>
                <div id="custom-color-options">
                    <div id="page-bg-color-option">
                        <label for="page-bg-color-input" class="block text-sm font-medium mb-1">Page Background Color:</label>
                        <input type="color" id="page-bg-color-input" value="#f3f4f6" class="h-10">
                    </div>

                    <div id="custom-color-section">
                        <label for="panel-bg-color-input" class="block text-sm font-medium mb-1 mt-3">Panel Background Color:</label>
                        <input type="color" id="panel-bg-color-input" value="#ffffff" class="h-10">
                        <label for="accent-color-input" class="block text-sm font-medium mb-1 mt-3">Accent Color:</label>
                        <input type="color" id="accent-color-input" value="#3b82f6" class="h-10">
                    </div>
                    <div id="custom-gradient-section" class="hidden">
                        <label for="gradient-color-1-input" class="block text-sm font-medium mb-1 mt-3">Gradient Color 1:</label>
                        <input type="color" id="gradient-color-1-input" value="#ffffff" class="h-10">
                        <label for="gradient-color-2-input" class="block text-sm font-medium mb-1 mt-3">Gradient Color 2:</label>
                        <input type="color" id="gradient-color-2-input" value="#e5e7eb" class="h-10">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 mt-3">Panel Style:</label>
                        <div class="flex space-x-2">
                            <button class="theme-option-button flex-1" data-panel-style="solid">Solid</button>
                            <button class="theme-option-button flex-1" data-panel-style="gradient">Gradient</button>
                        </div>
                    </div>
                </div>
                <button id="reset-theme-button" class="w-full mt-4 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reset to Default Theme</button>
            </div>
        </div>
    </div>

    <div id="font-settings-modal" class="modal-overlay hidden">
        <div id="modal-box-font" class="modal-box">
            <button id="font-modal-close-button" class="modal-close-button" aria-label="Close modal">&times;</button>
            <h3 class="text-lg font-semibold mb-6 text-center">Font Settings</h3>
            <div class="space-y-4">
                <div>
                    <label for="font-family-select" class="block text-sm font-medium mb-1">Font Family:</label>
                    <select id="font-family-select">
                        <option value="'Inter', sans-serif">Inter (Default)</option>
                        <option value="'Georgia', serif">Georgia (Serif)</option>
                        <option value="'Courier New', monospace">Courier New (Monospace)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Font Weight:</label>
                    <div class="flex space-x-2">
                        <button class="theme-option-button flex-1" data-font-weight="normal">Normal</button>
                        <button class="theme-option-button flex-1" data-font-weight="bold">Bold</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements (cached)
        const pokemonListElement = document.getElementById('pokemon-list');
        const pokemonNameElement = document.getElementById('pokemon-name');
        const pokemonIdElement = document.getElementById('pokemon-id');
        const pokemonImageElement = document.getElementById('pokemon-image');
        const pokemonTypesElement = document.getElementById('pokemon-types');
        const pokemonStatsElement = document.getElementById('pokemon-stats');
        const evolutionContentElement = document.getElementById('evolution-content');
        const evolutionLoaderElement = document.getElementById('evolution-loader');
        const listLoader = document.getElementById('list-loader');
        const listLoadingMessage = document.getElementById('list-loading-message');
        const detailLoader = document.getElementById('detail-loader');
        const searchInput = document.getElementById('search-input');
        const evolutionContainer = document.getElementById('pokemon-evolution');
        const genderButtonContainer = document.getElementById('gender-buttons');
        const maleButton = document.getElementById('btn-male');
        const femaleButton = document.getElementById('btn-female');
        const formsContainer = document.getElementById('pokemon-forms-container');
        const formsList = document.getElementById('pokemon-forms');
        const creditsButton = document.getElementById('credits-button');
        const creditsModal = document.getElementById('credits-modal');
        const modalCloseButtonCredits = document.getElementById('modal-close-button-credits');
        const searchInfoButton = document.getElementById('search-info-button');
        const searchHelpModal = document.getElementById('search-help-modal');
        const searchHelpModalCloseButton = document.getElementById('search-help-modal-close-button');

        // Theme & Settings Modal & Control Elements
        const themeButton = document.getElementById('theme-button');
        const settingsButton = document.getElementById('settings-button');
        const themeSettingsModal = document.getElementById('theme-settings-modal');
        const themeModalCloseButton = document.getElementById('theme-modal-close-button');
        const fontSettingsModal = document.getElementById('font-settings-modal');
        const fontModalCloseButton = document.getElementById('font-modal-close-button');

        const themeModeButtons = themeSettingsModal.querySelectorAll('[data-theme-mode]');
        const panelStyleButtons = themeSettingsModal.querySelectorAll('[data-panel-style]');
        const pageBgColorInput = document.getElementById('page-bg-color-input');
        const panelBgColorInput = document.getElementById('panel-bg-color-input');
        const accentColorInput = document.getElementById('accent-color-input');
        const gradientColor1Input = document.getElementById('gradient-color-1-input');
        const gradientColor2Input = document.getElementById('gradient-color-2-input');
        const customColorOptionsDiv = document.getElementById('custom-color-options');
        const pageBgColorOptionDiv = document.getElementById('page-bg-color-option');
        const customColorSection = document.getElementById('custom-color-section');
        const customGradientSection = document.getElementById('custom-gradient-section');
        const resetThemeButton = document.getElementById('reset-theme-button');

        const fontFamilySelect = document.getElementById('font-family-select');
        const fontWeightButtons = fontSettingsModal.querySelectorAll('[data-font-weight]');


        // Constants and State
        const POKEAPI_BASE_URL = 'https://pokeapi.co/api/v2';
        const POKEMON_LIMIT = 1302;
        let allPokemonData = [];
        let detailedPokemonDataCache = {};
        let speciesDataCache = {};
        let evolutionChainCache = {};
        let currentPokemonDetails = null;
        let selectedGender = 'default';
        let themeDebounceTimer; // For debouncing color picker input

        // --- Utility Functions ---
        async function fetchData(url, cache = null) { if (cache && cache[url]) { return cache[url]; } try { const response = await fetch(url); if (!response.ok) { if (response.status === 404) { console.warn(`Not found (404): ${url}`); return null; } throw new Error(`HTTP error ${response.status} for ${url}`); } const data = await response.json(); if (cache) { cache[url] = data; } return data; } catch (error) { console.error("Fetch error:", error); return null; } }
        function formatPokemonId(id) { return id ? `#${String(id).padStart(3, '0')}` : '#???'; }
        function createTypeBadges(types) { if (!types || types.length === 0) return '<span class="text-gray-500 italic text-sm">No type data</span>'; pokemonTypesElement.innerHTML = ''; return types.map(typeInfo => { const typeName = typeInfo.type.name; return `<span class="type-badge type-${typeName}">${typeName}</span>`; }).join(''); }
        function createStatBars(stats) { if (!stats || stats.length === 0) return '<p class="text-center font-semibold mb-2 text-gray-600">Base Stats</p><p class="text-center text-gray-500 italic text-sm">No stats data</p>'; const maxStatValue = 255; const statNameMapping = { 'hp': 'HP', 'attack': 'Attack', 'defense': 'Defense', 'special-attack': 'Sp. Atk', 'special-defense': 'Sp. Def', 'speed': 'Speed' }; let statsHtml = `<p class="text-center font-semibold mb-3 text-gray-600">Base Stats</p>`; statsHtml += stats.map(statInfo => { const statName = statNameMapping[statInfo.stat.name] || statInfo.stat.name; const statValue = statInfo.base_stat; const statPercentage = statValue > 0 ? Math.max(1, (statValue / maxStatValue) * 100) : 0; return ` <div class="flex justify-between items-center mb-1.5"> <span class="font-medium text-gray-500 capitalize w-1/3 text-xs">${statName}</span> <span class="font-semibold text-gray-700 w-8 text-right text-xs">${statValue}</span> <div class="stat-bar-bg w-7/12 ml-2"> <div class="stat-bar" style="width: ${statPercentage}%;"></div> </div> </div>`; }).join(''); return statsHtml; }
        function findPokemonInList(name) { return allPokemonData.find(p => p.name.toLowerCase() === name.toLowerCase()); }
        function createEvolutionLink(name) { const pokemon = findPokemonInList(name); const displayName = name.replace(/-/g, ' '); if (pokemon) { return `<span class="evolution-link capitalize" data-pokemon-url="${pokemon.url}">${displayName}</span>`; } return `<span class="capitalize">${displayName}</span>`; }
        function parseEvolutionChain(chainData, currentSpeciesName) { let evolvesFrom = null, evolvesTo = []; function traverse(chainPart, predecessor = null) { if (!chainPart) return false; const speciesName = chainPart.species.name; if (speciesName === currentSpeciesName) { evolvesFrom = predecessor; evolvesTo = chainPart.evolves_to.map(evo => evo.species.name); return true; } for (const nextEvo of chainPart.evolves_to) { if (traverse(nextEvo, speciesName)) return true; } return false; } if (chainData?.chain) traverse(chainData.chain); else console.warn("Invalid chainData in parseEvolutionChain"); return { evolvesFrom, evolvesTo }; }
        async function displayEvolutionInfo(speciesName, evolutionChainUrl) { evolutionLoaderElement.style.display = 'block'; evolutionContentElement.innerHTML = ''; if (!evolutionChainUrl) { evolutionContentElement.innerHTML = '<span class="text-gray-500 italic text-sm">No evolution chain data available.</span>'; evolutionLoaderElement.style.display = 'none'; return; } const evolutionData = await fetchData(evolutionChainUrl, evolutionChainCache); evolutionLoaderElement.style.display = 'none'; if (!evolutionData || !evolutionData.chain) { evolutionContentElement.innerHTML = '<span class="text-red-500 italic text-sm">Could not load evolution data.</span>'; return; } const { evolvesFrom, evolvesTo } = parseEvolutionChain(evolutionData, speciesName); let html = '<div class="space-y-1 text-center text-sm">'; html += `<div><span class="font-medium text-gray-500">Evolves From:</span> ${evolvesFrom ? createEvolutionLink(evolvesFrom) : '<span class="italic text-gray-500">Base</span>'}</div>`; html += `<div><span class="font-medium text-gray-500">Evolves To:</span> ${evolvesTo.length > 0 ? evolvesTo.map(createEvolutionLink).join(', ') : '<span class="italic text-gray-500">None</span>'}</div>`; html += '</div>'; evolutionContentElement.innerHTML = html; }
        function updatePokemonImage() { if (!currentPokemonDetails) return; const sprites = currentPokemonDetails.sprites; const animatedSprites = sprites?.versions?.['generation-v']?.['black-white']?.animated; let newSrc = ''; const animatedFemale = animatedSprites?.front_female; const animatedDefault = animatedSprites?.front_default; const staticFemale = sprites?.front_female; const staticOfficial = sprites?.other?.['official-artwork']?.front_default; const staticDefault = sprites?.front_default; const placeholderImage = 'https://placehold.co/150x150/e0e0e0/a0a0a0?text=No+Image'; if (selectedGender === 'female') { newSrc = animatedFemale || staticFemale || animatedDefault || staticOfficial || staticDefault; } else { newSrc = animatedDefault || staticOfficial || staticDefault; } newSrc = newSrc || placeholderImage; if (pokemonImageElement.src !== newSrc) { pokemonImageElement.style.opacity = 0; setTimeout(() => { pokemonImageElement.src = newSrc; pokemonImageElement.alt = `Image of ${currentPokemonDetails.name} (${selectedGender})`; pokemonImageElement.onload = () => pokemonImageElement.style.opacity = 1; pokemonImageElement.onerror = () => { console.warn(`Sprite error for ${newSrc}. Falling back.`); const fallbackStatic = staticDefault || placeholderImage; pokemonImageElement.src = fallbackStatic; pokemonImageElement.alt = `Fallback image of ${currentPokemonDetails.name}`; pokemonImageElement.onload = () => pokemonImageElement.style.opacity = 1; pokemonImageElement.onerror = () => { pokemonImageElement.src = placeholderImage; pokemonImageElement.alt = 'Image unavailable'; pokemonImageElement.style.opacity = 1; }; }; if (pokemonImageElement.complete) { pokemonImageElement.style.opacity = 1; } }, 200); } else { pokemonImageElement.style.opacity = 1; } }
        function formatFormName(formName, baseName) { let displayName = formName.replace(baseName + '-', '').replace(/-/g, ' '); displayName = displayName.replace('mega x', 'Mega X').replace('mega y', 'Mega Y').replace('mega', 'Mega'); displayName = displayName.replace('alola', 'Alola').replace('galar', 'Galar').replace('hisui', 'Hisui'); return displayName || formName; }
        function displayOtherForms(speciesData, currentPokemonName) { formsContainer.classList.add('hidden'); formsList.innerHTML = ''; if (!speciesData || !speciesData.varieties || speciesData.varieties.length <= 1) { return; } const baseName = speciesData.name; let formsHtml = ''; speciesData.varieties.forEach(variety => { const varietyName = variety.pokemon.name; const varietyUrl = variety.pokemon.url; if (varietyName === currentPokemonName) { return; } if (!allPokemonData.some(p => p.name === varietyName)) { console.warn(`Variety ${varietyName} not found in initial list, skipping link.`); return; } const displayName = formatFormName(varietyName, baseName); formsHtml += `<span class="form-link" data-pokemon-url="${varietyUrl}">${displayName}</span>`; }); if (formsHtml) { formsList.innerHTML = formsHtml; formsContainer.classList.remove('hidden'); } }
        async function displayPokemonDetails(pokemonData) { pokemonTypesElement.innerHTML = ''; pokemonStatsElement.innerHTML = ''; evolutionContentElement.innerHTML = ''; formsContainer.classList.add('hidden'); formsList.innerHTML = ''; genderButtonContainer.classList.add('hidden'); maleButton.classList.remove('active-male'); femaleButton.classList.remove('active-female'); maleButton.disabled = false; femaleButton.disabled = false; selectedGender = 'default'; if (!pokemonData) { currentPokemonDetails = null; pokemonNameElement.textContent = 'Error'; pokemonIdElement.textContent = '#???'; pokemonImageElement.src = 'https://placehold.co/150x150/e0e0e0/a0a0a0?text=Error'; pokemonImageElement.alt = 'Error loading Pokemon'; pokemonImageElement.style.opacity = 1; pokemonTypesElement.innerHTML = '<span class="text-red-500 italic text-sm">Could not load data</span>'; pokemonStatsElement.innerHTML = '<p class="text-center font-semibold mb-2 text-gray-600">Base Stats</p><p class="text-center text-red-500 italic text-sm">Could not load data.</p>'; evolutionContentElement.innerHTML = '<p class="text-center text-red-500 italic text-sm">Could not load data.</p>'; evolutionLoaderElement.style.display = 'none'; return; } currentPokemonDetails = pokemonData; pokemonNameElement.textContent = pokemonData.name.replace(/-/g, ' '); pokemonIdElement.textContent = formatPokemonId(pokemonData.id); updatePokemonImage(); pokemonTypesElement.innerHTML = createTypeBadges(pokemonData.types); pokemonStatsElement.innerHTML = createStatBars(pokemonData.stats); if (pokemonData.species?.url) { const speciesData = await fetchData(pokemonData.species.url, speciesDataCache); if (speciesData) { const genderRate = speciesData.gender_rate; const hasFemaleSprite = !!(pokemonData.sprites?.versions?.['generation-v']?.['black-white']?.animated?.front_female || pokemonData.sprites?.front_female); if (genderRate !== -1) { genderButtonContainer.classList.remove('hidden'); femaleButton.disabled = (genderRate === 0 || !hasFemaleSprite); maleButton.disabled = (genderRate === 8); } displayOtherForms(speciesData, pokemonData.name); if (speciesData.evolution_chain?.url) { await displayEvolutionInfo(speciesData.name, speciesData.evolution_chain.url); } else { evolutionContentElement.innerHTML = '<span class="text-gray-500 italic text-sm">No evolution chain data available.</span>'; evolutionLoaderElement.style.display = 'none'; } } else { evolutionContentElement.innerHTML = '<span class="text-red-500 italic text-sm">Could not load species data.</span>'; evolutionLoaderElement.style.display = 'none'; genderButtonContainer.classList.add('hidden'); formsContainer.classList.add('hidden'); } } else { evolutionContentElement.innerHTML = '<span class="text-gray-500 italic text-sm">Species data unavailable.</span>'; evolutionLoaderElement.style.display = 'none'; genderButtonContainer.classList.add('hidden'); formsContainer.classList.add('hidden'); } }
        async function handlePokemonSelection(url, listItemElement) { if (!url) return; detailLoader.style.display = 'block'; pokemonImageElement.style.display = 'none'; pokemonTypesElement.innerHTML = ''; pokemonStatsElement.innerHTML = '<p class="text-center font-semibold mb-2 text-gray-600">Base Stats</p><div class="loader" style="width:20px; height:20px; margin: 5px auto;"></div>'; evolutionContentElement.innerHTML = ''; evolutionLoaderElement.style.display = 'block'; formsContainer.classList.add('hidden'); formsList.innerHTML = ''; pokemonNameElement.textContent = 'Loading...'; pokemonIdElement.textContent = '#...'; genderButtonContainer.classList.add('hidden'); const currentlySelected = pokemonListElement.querySelector('.selected'); if (currentlySelected) { currentlySelected.classList.remove('selected'); } if (listItemElement) { listItemElement.classList.add('selected'); } const pokemonDetails = await fetchData(url, detailedPokemonDataCache); detailLoader.style.display = 'none'; pokemonImageElement.style.display = 'block'; await displayPokemonDetails(pokemonDetails); }
        function populatePokemonList(pokemonList) { pokemonListElement.innerHTML = ''; if (!pokemonList || pokemonList.length === 0) { pokemonListElement.innerHTML = '<li class="text-center text-gray-500 italic p-4">No Pokémon found.</li>'; return; } pokemonList.sort((a, b) => a.name.localeCompare(b.name)); const fragment = document.createDocumentFragment(); pokemonList.forEach(pokemon => { const listItem = document.createElement('li'); listItem.className = 'pokemon-list-item'; listItem.dataset.url = pokemon.url; listItem.dataset.name = pokemon.name; const spriteImg = document.createElement('img'); const urlParts = pokemon.url.split('/').filter(part => part); const pokemonId = urlParts[urlParts.length - 1]; spriteImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonId}.png`; spriteImg.alt = ''; spriteImg.loading = 'lazy'; spriteImg.onerror = (e) => { e.target.classList.add('error'); }; listItem.dataset.id = pokemonId; const nameSpan = document.createElement('span'); nameSpan.textContent = pokemon.name.replace(/-/g, ' '); listItem.appendChild(spriteImg); listItem.appendChild(nameSpan); fragment.appendChild(listItem); }); pokemonListElement.appendChild(fragment); }
        function filterPokemonList() { const searchTerm = searchInput.value.toLowerCase().trim(); const listItems = pokemonListElement.querySelectorAll('li'); listItems.forEach(item => { const pokemonName = item.dataset.name || ''; const pokemonId = item.dataset.id || ''; let isMatch = false; if (searchTerm.startsWith('#')) { const idTerm = searchTerm.substring(1); isMatch = pokemonId === idTerm; } else { const nameMatch = pokemonName.includes(searchTerm); const startsWithIdMatch = /^\d+$/.test(searchTerm) && pokemonId.startsWith(searchTerm); isMatch = nameMatch || startsWithIdMatch; } item.style.display = isMatch ? 'flex' : 'none'; }); }
        function handleGenderClick(event) { const button = event.target.closest('.gender-button'); if (!button || button.disabled) return; const gender = button.dataset.gender; if (button.classList.contains(`active-${gender}`)) { selectedGender = 'default'; button.classList.remove(`active-${gender}`); } else { selectedGender = gender; maleButton.classList.remove('active-male'); femaleButton.classList.remove('active-female'); button.classList.add(`active-${gender}`); } updatePokemonImage(); }

        // --- Theme and Font Setting Functions ---
        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? '#1f2937' : '#ffffff'; // Default dark text on light bg, white on dark bg
        }

        function applyTheme() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const isLegacyMode = document.body.classList.contains('legacy-mode');
            const rootStyle = document.documentElement.style;
            const panelElements = document.querySelectorAll('.panel');
            const modalBoxes = document.querySelectorAll('.modal-box');

            panelElements.forEach(panel => { panel.style.backgroundImage = ''; panel.style.backgroundColor = ''; });
            modalBoxes.forEach(box => box.style.backgroundColor = '');

            if (isLegacyMode) {
                customColorOptionsDiv.classList.add('hidden');
                pageBgColorOptionDiv.classList.add('hidden');
                // Legacy styles are primarily handled by CSS variables in body.legacy-mode
                rootStyle.setProperty('--text-panel-default', 'var(--text-default)'); // Uses legacy's --text-default
                modalBoxes.forEach(box => box.style.backgroundColor = 'var(--modal-bg)');
            } else {
                customColorOptionsDiv.classList.remove('hidden');
                pageBgColorOptionDiv.classList.remove('hidden');

                rootStyle.setProperty('--bg-page', pageBgColorInput.value);
                rootStyle.setProperty('--text-default', isDarkMode ? '#f3f4f6' : '#1f2937');
                rootStyle.setProperty('--text-muted', isDarkMode ? '#9ca3af' : '#6b7280');
                rootStyle.setProperty('--border-color', isDarkMode ? '#4b5563' : '#d1d5db');
                rootStyle.setProperty('--button-secondary-bg', isDarkMode ? '#374151' : '#e5e7eb');
                rootStyle.setProperty('--modal-bg', isDarkMode ? '#1f2937' : '#ffffff');

                if (customGradientSection.classList.contains('hidden')) { // Solid color selected
                    const panelBg = panelBgColorInput.value;
                    rootStyle.setProperty('--panel-bg', panelBg);
                    rootStyle.setProperty('--panel-bg-image', 'none');
                    rootStyle.setProperty('--text-panel-default', getContrastYIQ(panelBg));
                } else { // Gradient selected
                    const color1 = gradientColor1Input.value;
                    const color2 = gradientColor2Input.value;
                    const gradient = `linear-gradient(to bottom, ${color1}, ${color2})`;
                    rootStyle.setProperty('--panel-bg-image', gradient);
                    rootStyle.setProperty('--panel-bg', 'transparent');
                    rootStyle.setProperty('--text-panel-default', isDarkMode ? '#f3f4f6' : '#1f2937');
                }
                modalBoxes.forEach(box => box.style.backgroundColor = 'var(--modal-bg)'); // Apply the correct modal bg

                const newAccentColor = accentColorInput.value;
                rootStyle.setProperty('--accent-color', newAccentColor);
                rootStyle.setProperty('--accent-hover', shadeColor(newAccentColor, -10));
                rootStyle.setProperty('--accent-focus-ring', hexToRgba(newAccentColor, 0.3));
                rootStyle.setProperty('--list-item-selected-border', newAccentColor);
            }

            // Explicitly set title colors based on the final panel text color
            const currentPanelTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-panel-default').trim();
            document.querySelectorAll('.panel h2, .panel .section-title, #pokemon-name, #pokemon-id').forEach(titleEl => {
                titleEl.style.color = currentPanelTextColor;
            });
            // Specific override for dark mode titles if the panel text is dark (e.g., from a custom light panel bg)
            if (isDarkMode && !isLegacyMode) {
                 const panelBgForContrast = customGradientSection.classList.contains('hidden') ? panelBgColorInput.value : '#1f2937'; // Use dark default for gradient
                 if (getContrastYIQ(panelBgForContrast) === '#1f2937') { // If calculated text for panel is dark
                     document.querySelectorAll('.panel h2, .panel .section-title, #pokemon-name, #pokemon-id').forEach(titleEl => {
                        titleEl.style.color = 'var(--text-default)'; // Force light text
                    });
                 }
            }
        }


        function applyFontSettings() {
            document.documentElement.style.setProperty('--font-family', fontFamilySelect.value);
            const selectedWeightButton = fontSettingsModal.querySelector('[data-font-weight].active');
            const weight = selectedWeightButton ? (selectedWeightButton.dataset.fontWeight === 'bold' ? 'var(--font-weight-bold)' : 'var(--font-weight-normal)') : 'var(--font-weight-normal)';
            document.documentElement.style.setProperty('--current-font-weight', weight);
        }

        function shadeColor(color, percent) { let R = parseInt(color.substring(1,3),16); let G = parseInt(color.substring(3,5),16); let B = parseInt(color.substring(5,7),16); R = parseInt(R * (100 + percent) / 100); G = parseInt(G * (100 + percent) / 100); B = parseInt(B * (100 + percent) / 100); R = (R<255)?R:255; G = (G<255)?G:255; B = (B<255)?B:255; R = Math.max(0, R); G = Math.max(0, G); B = Math.max(0, B); const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16)); const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16)); const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16)); return "#"+RR+GG+BB; }
        function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

        // Debounce function
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        const debouncedApplyTheme = debounce(applyTheme, 250);


        /** Initializes the Pokedex */
        async function initializePokedex() {
            console.log("Pokedex initializing...");

            // Event Delegation Setup
            pokemonListElement.addEventListener('click', (event) => { const li = event.target.closest('li'); if (li?.dataset.url) handlePokemonSelection(li.dataset.url, li); });
            evolutionContainer.addEventListener('click', (event) => { const link = event.target.closest('.evolution-link'); if (link?.dataset.pokemonUrl) { const url = link.dataset.pokemonUrl; const li = pokemonListElement.querySelector(`li[data-url="${url}"]`); if (li) { li.scrollIntoView({ behavior: 'smooth', block: 'center' }); handlePokemonSelection(url, li); } else { handlePokemonSelection(url, null); } } });
            maleButton.addEventListener('click', handleGenderClick);
            femaleButton.addEventListener('click', handleGenderClick);
            formsContainer.addEventListener('click', (event) => { const link = event.target.closest('.form-link'); if (link?.dataset.pokemonUrl) { const url = link.dataset.pokemonUrl; const li = pokemonListElement.querySelector(`li[data-url="${url}"]`); if (li) { li.scrollIntoView({ behavior: 'smooth', block: 'center' }); handlePokemonSelection(url, li); } else { handlePokemonSelection(url, null); } } });

            // Modal Event Listeners
            creditsButton.addEventListener('click', () => { creditsModal.classList.remove('hidden'); });
            modalCloseButtonCredits.addEventListener('click', () => { creditsModal.classList.add('hidden'); });
            creditsModal.addEventListener('click', (event) => { if (event.target === creditsModal) { creditsModal.classList.add('hidden'); } });

            searchInfoButton.addEventListener('click', () => { searchHelpModal.classList.remove('hidden'); });
            searchHelpModalCloseButton.addEventListener('click', () => { searchHelpModal.classList.add('hidden'); });
            searchHelpModal.addEventListener('click', (event) => { if (event.target === searchHelpModal) { searchHelpModal.classList.add('hidden'); } });

            // Theme & Settings Modal Listeners
            if (themeButton) themeButton.addEventListener('click', () => themeSettingsModal.classList.remove('hidden'));
            if (themeModalCloseButton) themeModalCloseButton.addEventListener('click', () => themeSettingsModal.classList.add('hidden'));
            if (themeSettingsModal) themeSettingsModal.addEventListener('click', (event) => { if (event.target === themeSettingsModal) themeSettingsModal.classList.add('hidden'); });

            if (settingsButton) settingsButton.addEventListener('click', () => fontSettingsModal.classList.remove('hidden'));
            if (fontModalCloseButton) fontModalCloseButton.addEventListener('click', () => fontSettingsModal.classList.add('hidden'));
            if (fontSettingsModal) fontSettingsModal.addEventListener('click', (event) => { if (event.target === fontSettingsModal) fontSettingsModal.classList.add('hidden'); });

            // Theme Mode Buttons
            if (themeModeButtons) themeModeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    themeModeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const mode = button.dataset.themeMode;
                    document.body.classList.remove('dark-mode', 'legacy-mode');
                    customColorOptionsDiv.classList.remove('hidden');
                    pageBgColorOptionDiv.classList.remove('hidden');

                    if (mode === 'dark') {
                        document.body.classList.add('dark-mode');
                    } else if (mode === 'legacy') {
                        document.body.classList.add('legacy-mode');
                        customColorOptionsDiv.classList.add('hidden');
                        pageBgColorOptionDiv.classList.add('hidden');
                    }
                    applyTheme();
                });
            });
            if (themeSettingsModal) themeSettingsModal.querySelector('[data-theme-mode="light"]')?.classList.add('active');


            // Panel Style Buttons (Solid/Gradient)
            if (panelStyleButtons) panelStyleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    panelStyleButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    if (button.dataset.panelStyle === 'gradient') {
                        customColorSection.classList.add('hidden');
                        customGradientSection.classList.remove('hidden');
                    } else {
                        customColorSection.classList.remove('hidden');
                        customGradientSection.classList.add('hidden');
                    }
                    applyTheme();
                });
            });
            if (themeSettingsModal) themeSettingsModal.querySelector('[data-panel-style="solid"]')?.classList.add('active');


            // Color Inputs with Debounce
            if (pageBgColorInput) pageBgColorInput.addEventListener('input', debouncedApplyTheme);
            if (panelBgColorInput) panelBgColorInput.addEventListener('input', debouncedApplyTheme);
            if (accentColorInput) accentColorInput.addEventListener('input', debouncedApplyTheme);
            if (gradientColor1Input) gradientColor1Input.addEventListener('input', debouncedApplyTheme);
            if (gradientColor2Input) gradientColor2Input.addEventListener('input', debouncedApplyTheme);


            // Reset Theme Button
            if (resetThemeButton) resetThemeButton.addEventListener('click', () => {
                document.body.classList.remove('dark-mode', 'legacy-mode');
                themeModeButtons.forEach(btn => btn.classList.remove('active'));
                themeSettingsModal.querySelector('[data-theme-mode="light"]').classList.add('active');

                panelStyleButtons.forEach(btn => btn.classList.remove('active'));
                themeSettingsModal.querySelector('[data-panel-style="solid"]').classList.add('active');
                customColorOptionsDiv.classList.remove('hidden');
                pageBgColorOptionDiv.classList.remove('hidden');
                customColorSection.classList.remove('hidden');
                customGradientSection.classList.add('hidden');

                const rootStyle = document.documentElement.style;
                rootStyle.removeProperty('--bg-page');
                rootStyle.removeProperty('--text-panel-default');
                rootStyle.removeProperty('--panel-bg');
                rootStyle.removeProperty('--panel-bg-image');
                rootStyle.removeProperty('--accent-color');
                rootStyle.removeProperty('--accent-hover');
                rootStyle.removeProperty('--accent-focus-ring');
                rootStyle.removeProperty('--list-item-selected-border');
                rootStyle.removeProperty('--modal-bg');
                document.querySelectorAll('.panel').forEach(panel => panel.style.backgroundImage = '');
                document.querySelectorAll('.modal-box').forEach(box => box.style.backgroundColor = '');


                pageBgColorInput.value = '#f3f4f6';
                panelBgColorInput.value = '#ffffff';
                accentColorInput.value = '#3b82f6';
                gradientColor1Input.value = '#ffffff';
                gradientColor2Input.value = '#e5e7eb';
                applyTheme();
            });


            // Font Family Select
            if (fontFamilySelect) fontFamilySelect.addEventListener('change', applyFontSettings);

            // Font Weight Buttons
            if (fontWeightButtons) fontWeightButtons.forEach(button => {
                button.addEventListener('click', () => {
                    fontWeightButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    applyFontSettings();
                });
            });
            if (fontSettingsModal) fontSettingsModal.querySelector('[data-font-weight="normal"]')?.classList.add('active');


            // Initial list fetch
            listLoader.style.display = 'block';
            listLoadingMessage.style.display = 'block';
            pokemonListElement.innerHTML = '';
            console.log("List cleared, loader shown.");

            const listUrl = `${POKEAPI_BASE_URL}/pokemon?limit=${POKEMON_LIMIT}&offset=0`;
            console.log("Fetching Pokémon list from:", listUrl);
            const pokemonListData = await fetchData(listUrl);

            listLoader.style.display = 'none';
            listLoadingMessage.style.display = 'none';
            console.log("List fetch complete. Loader hidden.");

            if (pokemonListData && pokemonListData.results && pokemonListData.results.length > 0) {
                console.log(`Received ${pokemonListData.results.length} Pokémon.`);
                allPokemonData = pokemonListData.results;
                populatePokemonList(allPokemonData);
                console.log("populatePokemonList called.");
            } else if (pokemonListData && pokemonListData.results && pokemonListData.results.length === 0) {
                console.log("Received 0 Pokémon. Displaying 'No Pokémon found'.");
                pokemonListElement.innerHTML = '<li class="text-center text-gray-500 italic p-4">No Pokémon found in the results.</li>';
            }
            else {
                console.error("Failed to fetch Pokémon list or no results found. pokemonListData:", pokemonListData);
                pokemonListElement.innerHTML = '<li class="text-center text-red-500 italic p-4">Failed to load Pokémon list. Please try refreshing.</li>';
            }

            applyTheme();
            applyFontSettings();
            console.log("Pokedex initialization finished.");
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', filterPokemonList);

        // --- Start ---
        document.addEventListener('DOMContentLoaded', () => {
            initializePokedex();
        });

    </script>

</body>
</html>
